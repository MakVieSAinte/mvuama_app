<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Création des tables Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      textarea {
        width: 100%;
        height: 300px;
      }
      button {
        padding: 10px 20px;
        margin-top: 10px;
        background-color: #3ecf8e;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #output {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        min-height: 100px;
      }
    </style>
  </head>
  <body>
    <h1>Création des tables pour MVUAMA</h1>

    <div>
      <label for="apiUrl">URL Supabase</label>
      <input
        type="text"
        id="apiUrl"
        placeholder="https://votre-projet.supabase.co"
        style="width: 100%"
      />
    </div>

    <div style="margin-top: 10px">
      <label for="apiKey">Clé API Supabase (anon ou service_role)</label>
      <input type="text" id="apiKey" placeholder="votre-clé-api-supabase" style="width: 100%" />
    </div>

    <div style="margin-top: 10px">
      <label for="sqlScript">Script SQL à exécuter</label>
      <textarea id="sqlScript">
-- Création de la table users (si elle n'existe pas déjà)
CREATE TABLE IF NOT EXISTS public.users (
    id UUID PRIMARY KEY REFERENCES auth.users(id),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    display_name VARCHAR(200),
    avatar_url TEXT,
    phone VARCHAR(50),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- Création de la table agencies
CREATE TABLE IF NOT EXISTS public.agencies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    code VARCHAR(50),
    type VARCHAR(50) DEFAULT 'headquarters',
    status VARCHAR(20) DEFAULT 'active',
    country VARCHAR(2),
    city VARCHAR(100),
    address TEXT,
    postal_code VARCHAR(20),
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    phone VARCHAR(50),
    mobile_phone VARCHAR(50),
    contact_email VARCHAR(255),
    contact_phone VARCHAR(50),
    website VARCHAR(255),
    logo_url TEXT,
    description TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID NOT NULL REFERENCES auth.users(id),
    deleted_at TIMESTAMP WITH TIME ZONE
);

-- Création de la table memberships
CREATE TABLE IF NOT EXISTS public.memberships (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    agency_id UUID NOT NULL REFERENCES public.agencies(id),
    user_id UUID NOT NULL REFERENCES public.users(id),
    role VARCHAR(50) DEFAULT 'member',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by UUID NOT NULL REFERENCES auth.users(id),
    deleted_at TIMESTAMP WITH TIME ZONE,
    UNIQUE(agency_id, user_id) WHERE deleted_at IS NULL
);

-- Création des fonctions et triggers nécessaires
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Création des triggers pour toutes les tables
CREATE TRIGGER set_updated_at_agencies
BEFORE UPDATE ON public.agencies
FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER set_updated_at_users
BEFORE UPDATE ON public.users
FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER set_updated_at_memberships
BEFORE UPDATE ON public.memberships
FOR EACH ROW EXECUTE FUNCTION update_updated_at();
        </textarea
      >
    </div>

    <button id="execute">Exécuter le script SQL</button>

    <div>
      <h3>Résultat :</h3>
      <pre id="output">Les résultats s'afficheront ici...</pre>
    </div>

    <script>
      document.getElementById('execute').addEventListener('click', async function () {
        const output = document.getElementById('output')
        const apiUrl = document.getElementById('apiUrl').value
        const apiKey = document.getElementById('apiKey').value
        const sqlScript = document.getElementById('sqlScript').value

        if (!apiUrl || !apiKey) {
          output.innerText = "Veuillez saisir l'URL et la clé API Supabase"
          return
        }

        try {
          output.innerText = 'Exécution du script SQL...'

          const supabase = supabaseClient.createClient(apiUrl, apiKey)

          // Exécuter le script SQL via l'API REST
          const { data, error } = await supabase.rpc('exec_sql', {
            query_text: sqlScript,
          })

          if (error) throw error

          output.innerText =
            'Script exécuté avec succès!\n\nRésultat:\n' + JSON.stringify(data, null, 2)
        } catch (error) {
          output.innerText =
            "Erreur lors de l'exécution du script:\n" + JSON.stringify(error, null, 2)
          console.error(error)
        }
      })
    </script>
  </body>
</html>
